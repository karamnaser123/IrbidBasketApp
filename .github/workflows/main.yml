name: iOS Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Xcode
      uses: macos-setup-actions/setup-xcode@v1
      with:
        xcode-version: '12.5'

    - name: Install dependencies
      run: |
        sudo gem install cocoapods
        pod install

    - name: Build the app
      run: |
        xcodebuild clean build -workspace MyApp.xcworkspace -scheme MyApp -sdk iphoneos -configuration Release

    - name: Export Archive
      run: |
        xcodebuild -exportArchive -archivePath build/MyApp.xcarchive -exportOptionsPlist exportOptions.plist -exportPath build

    - name: Upload IPA to App Store Connect
      uses: apple-actions/app-store-connect@v1
      with:
        app_identifier: 'com.irbidbasket.app'  # معرف التطبيق في App Store Connect
        ipa_path: 'MyApp.ipa'  # المسار إلى ملف IPA
        issuer_id: ${{ secrets.ISSUER_ID }}  # قم بتخزين Issuer ID في GitHub Secrets
        key_id: ${{ secrets.KEY_ID }}  # قم بتخزين Key ID في GitHub Secrets
        api_key: ${{ secrets.APP_STORE_API_KEY }}  # قم بتخزين API Key في GitHub Secrets
